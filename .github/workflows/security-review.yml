name: Security Review (Reusable)

on:
  workflow_call:
    inputs:
      model:
        description: "Claude model to use for the review"
        type: string
        default: "claude-sonnet-4-5"
      max_turns:
        description: "Maximum agentic turns for the review"
        type: number
        default: 10
      extra_instructions:
        description: "Additional instructions appended to the review prompt"
        type: string
        default: ""
    secrets:
      WIF_PROVIDER:
        required: true
      WIF_SERVICE_ACCOUNT:
        required: true

permissions:
  contents: read
  pull-requests: write
  id-token: write

jobs:
  security-review:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout calling repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout security review rules
        uses: actions/checkout@v4
        with:
          repository: polen-dev/security-reviews
          path: .security-config
          sparse-checkout: |
            rules/
            schemas/
            CLAUDE.md
          sparse-checkout-cone-mode: false

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Run security review
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          use_vertex: "true"
          github_token: ${{ github.token }}
          prompt: |
            You are a security reviewer for polen-dev.

            ## Task
            Review this PR for security vulnerabilities. Focus ONLY on the diff.

            ## Rules
            Read and apply ALL of these:
            - .security-config/rules/security-rules.md
            - .security-config/rules/false-positives.md
            - .security-config/rules/polen-specific.md

            ${{ inputs.extra_instructions }}

            ## Output Format
            Respond with a markdown security review report. Structure it as:

            1. A summary header with total findings count by severity
            2. Each finding with: severity emoji, title, file:line, description, and fix recommendation
            3. At the end, output a JSON code block with structured findings matching .security-config/schemas/findings.json

            Use these severity emojis:
            - CRITICAL: ðŸš¨
            - HIGH: âš ï¸
            - MEDIUM: ðŸ“‹
            - LOW: â„¹ï¸
            - INFO: ðŸ’¡

            ## Important
            - Be precise. Flag real issues, not theoretical ones.
            - Every finding needs file, line, and fix recommendation.
            - If the PR is clean, say so clearly. Do not invent issues.
          claude_args: >-
            --model ${{ inputs.model }}
            --max-turns ${{ inputs.max_turns }}
            --allowedTools "Read,Glob,Grep,Bash(git diff:*),Bash(git log:*),Bash(git show:*)"
        env:
          ANTHROPIC_VERTEX_PROJECT_ID: polen-agents
          CLOUD_ML_REGION: us-east5

      - name: Post review and check findings
        if: always() && steps.review.outcome == 'success'
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
        run: |
          OUTPUT_FILE="${RUNNER_TEMP}/claude-execution-output.json"

          if [ ! -f "$OUTPUT_FILE" ]; then
            echo "No execution output file found at $OUTPUT_FILE"
            echo "Listing RUNNER_TEMP contents:"
            ls -la "$RUNNER_TEMP"/ || true
            exit 0
          fi

          # Extract Claude's final result text
          TMPFILE=$(mktemp)
          jq -r '.result // empty' "$OUTPUT_FILE" > "$TMPFILE" 2>/dev/null

          if [ ! -s "$TMPFILE" ]; then
            echo "No result in execution output."
            rm -f "$TMPFILE"
            exit 0
          fi

          # Prepend header and append footer
          COMMENT_FILE=$(mktemp)
          echo "## ðŸ”’ Security Review" > "$COMMENT_FILE"
          echo "" >> "$COMMENT_FILE"
          cat "$TMPFILE" >> "$COMMENT_FILE"
          echo "" >> "$COMMENT_FILE"
          echo "---" >> "$COMMENT_FILE"
          echo "*Automated security review by Claude on Vertex AI*" >> "$COMMENT_FILE"

          # Post as PR comment
          gh pr comment "$PR_NUMBER" --repo "$REPO" --body-file "$COMMENT_FILE"
          echo "Review comment posted."

          # Check for CRITICAL findings
          if grep -qi "CRITICAL" "$TMPFILE"; then
            echo "::error::Security review found CRITICAL findings. See PR comment for details."
            rm -f "$TMPFILE" "$COMMENT_FILE"
            exit 1
          fi

          rm -f "$TMPFILE" "$COMMENT_FILE"
          echo "No CRITICAL findings detected."
